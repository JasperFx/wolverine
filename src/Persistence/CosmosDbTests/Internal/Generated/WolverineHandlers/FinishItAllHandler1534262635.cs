// <auto-generated/>
#pragma warning disable
using Microsoft.Azure.Cosmos;

namespace Internal.Generated.WolverineHandlers
{
    // START: FinishItAllHandler1534262635
    [global::System.CodeDom.Compiler.GeneratedCode("JasperFx", "1.0.0")]
    public sealed class FinishItAllHandler1534262635 : Wolverine.Runtime.Handlers.MessageHandler
    {
        private readonly Microsoft.Azure.Cosmos.Container _container;

        public FinishItAllHandler1534262635(Microsoft.Azure.Cosmos.Container container)
        {
            _container = container;
        }



        public override async System.Threading.Tasks.Task HandleAsync(Wolverine.Runtime.MessageContext context, System.Threading.CancellationToken cancellation)
        {
            // The actual message body
            var finishItAll = (Wolverine.ComplianceTests.Sagas.FinishItAll)context.Envelope.Message;


            // Enlist in CosmosDB outbox transaction
            context.EnlistInOutbox(new Wolverine.CosmosDb.Internals.CosmosDbEnvelopeTransaction(_container, context));
            var sagaId = context.Envelope.SagaId;
            if (string.IsNullOrEmpty(sagaId)) throw new Wolverine.Persistence.Sagas.IndeterminateSagaStateIdException(context.Envelope);
            
            // Try to load the existing saga document from CosmosDB
            Wolverine.ComplianceTests.Sagas.StringBasicWorkflow stringBasicWorkflow = default;
            try
            {
                var _cosmosResponse = await _container.ReadItemAsync<Wolverine.ComplianceTests.Sagas.StringBasicWorkflow>(sagaId, Microsoft.Azure.Cosmos.PartitionKey.None, cancellationToken: cancellation).ConfigureAwait(false);
                stringBasicWorkflow = _cosmosResponse.Resource;
            }
            catch (Microsoft.Azure.Cosmos.CosmosException e) when (e.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                stringBasicWorkflow = default;
            }
            if (stringBasicWorkflow == null)
            {
                throw new Wolverine.Persistence.Sagas.UnknownSagaException(typeof(Wolverine.ComplianceTests.Sagas.StringBasicWorkflow), sagaId);
            }

            else
            {
                context.SetSagaId(sagaId);
                
                // The actual message execution
                stringBasicWorkflow.Handle(finishItAll);

                // Delete the saga if completed, otherwise update it
                if (stringBasicWorkflow.IsCompleted())
                {
                    await _container.DeleteItemAsync<Wolverine.ComplianceTests.Sagas.StringBasicWorkflow>(sagaId, Microsoft.Azure.Cosmos.PartitionKey.None).ConfigureAwait(false);
                }

                else
                {
                    await _container.UpsertItemAsync(stringBasicWorkflow).ConfigureAwait(false);
                }

                
                // Have to flush outgoing messages just in case Marten did nothing because of https://github.com/JasperFx/wolverine/issues/536
                await context.FlushOutgoingMessagesAsync().ConfigureAwait(false);

            }

        }

    }

    // END: FinishItAllHandler1534262635
    
    
}

